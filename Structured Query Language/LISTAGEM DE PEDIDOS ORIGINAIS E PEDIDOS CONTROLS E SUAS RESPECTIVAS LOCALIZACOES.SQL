EXECUTE BLOCK
RETURNS (
    /*
        RETORNOS DO PEDIDO DE CLIENTE CONTROL.
    */
    CODIGOEMPRESACONTROL INTEGER,
    DATAEMISSAOCONTROL DATE,
    IDPEDIDOCONTROL INTEGER,
    CODIGOCLIENTECONTROL INTEGER,
    NOMECLIENTECONTROL VARCHAR(255),

    /*
        RETORNOS DO PEDIDO DE CLIENTE ORIGINAL.
    */
    CODIGOEMPRESAORIGINAL INTEGER,
    DATAEMISSAOORIGINAL DATE,
    IDPEDIDOORIGINAL INTEGER,
    CODIGOCLIENTEORIGINAL INTEGER,
    NOMECLIENTEORIGINAL VARCHAR(255),

    /*
        RETORNOS DO HISTÓRICO DO PEDIDO DE CLIENTE CONTROL.
    */
    CODIGOLOCALIZACAOCONTROL INTEGER,
    NOMELOCALIZACAOCONTROL VARCHAR(30),
    DATALOCALIZACAOCONTROL DATE,
    HORALOCALIZACAOCONTROL TIME
    )
AS
    /*
        INICIALIZAÇÃO DE VARIÁVEIS: ORIGEM DE PEDIDO: CONTROL; CÓDIGO DA EMPRESA: MATRIZ; E SITUAÇÃO DO PEDIDO: ABERTO.
    */
    DECLARE VARIABLE DATAEMISSAOINICIAL DATE = @#DATE#DATAEMISSAO@;
    DECLARE VARIABLE CONSTORIGEMPEDIDO CHAR(1) = 'L';
    DECLARE VARIABLE CONSTCODIGOEMPRESA INTEGER = 1;
    DECLARE VARIABLE CONSTSITUACAOPEDIDO CHAR(1) = 'A';
BEGIN
    FOR
        SELECT
            /*
                CONSULTAS DO PEDIDO DE CLIENTE CONTROL.
            */
            PEDCONTROL.EMPCODIGO,
            PEDCONTROL.PEDDTEMIS,
            PEDCONTROL.ID_PEDIDO,
            PEDCONTROL.CLICODIGO,
            UPPER(CLICONTROL.CLIRAZSOCIAL),

            /*
                CONSULTAS DO PEDIDO DE CLIENTE ORIGINAL.
            */
            PEDORIGINAL.EMPCODIGO,
            PEDORIGINAL.PEDDTEMIS,
            PEDORIGINAL.ID_PEDIDO,
            PEDORIGINAL.CLICODIGO,
            UPPER(CLIORIGINAL.CLIRAZSOCIAL),

            /*
                CONSULTAS DO HISTÓRICO DO PEDIDO DE CLIENTE CONTROL.
            */
            ACOCONTROL.LPCODIGO,
            UPPER(LOCALPED.LPDESCRICAO),
            CAST(ACOCONTROL.APDATA AS DATE),
            CAST(ACOCONTROL.APHORA AS TIME)
        FROM PEDID PEDCONTROL
            LEFT JOIN PEDXPED           ON PEDCONTROL.ID_PEDIDO  = PEDXPED.ID_PEDDES
            LEFT JOIN CLIEN CLICONTROL  ON PEDCONTROL.CLICODIGO  = CLICONTROL.CLICODIGO
            LEFT JOIN PEDID PEDORIGINAL ON PEDXPED.ID_PEDORI     = PEDORIGINAL.ID_PEDIDO
            LEFT JOIN CLIEN CLIORIGINAL ON PEDORIGINAL.CLICODIGO = CLIORIGINAL.CLICODIGO
            LEFT JOIN ACOPED ACOCONTROL ON PEDCONTROL.ID_PEDIDO  = ACOCONTROL.ID_PEDIDO
            AND ACOCONTROL.APCODIGO = (
                /*
                    SELEÇÃO DA ÚLTIMA LOCALIZAÇÃO DO PEDIDO.
                */
                SELECT MAX(ACOPED.APCODIGO) FROM ACOPED
                WHERE ACOPED.APDATA >= :DATAEMISSAOINICIAL
                AND ACOPED.ID_PEDIDO = PEDCONTROL.ID_PEDIDO
            )
            LEFT JOIN LOCALPED          ON ACOCONTROL.LPCODIGO   = LOCALPED.LPCODIGO
        WHERE
            /*
                CONDIÇÕES DE FILTRO PARA SELECIONAR OS PEDIDOS DESEJADOS.
            */
            PEDCONTROL.PEDDTEMIS >= :DATAEMISSAOINICIAL
            AND PEDCONTROL.PEDORIGEM = :CONSTORIGEMPEDIDO
            AND PEDCONTROL.EMPCODIGO = :CONSTCODIGOEMPRESA
            AND PEDCONTROL.PEDSITPED = :CONSTSITUACAOPEDIDO
        ORDER BY
            PEDCONTROL.ID_PEDIDO

        INTO
            /*
                ATRIBUIÇÃO DOS RESULTADOS DA CONSULTA DO CONTROL ÀS VARIÁVEIS DE RETORNO.
            */
            :CODIGOEMPRESACONTROL,
            :DATAEMISSAOCONTROL,
            :IDPEDIDOCONTROL,
            :CODIGOCLIENTECONTROL,
            :NOMECLIENTECONTROL,
			
            /*
                ATRIBUIÇÃO DOS RESULTADOS DA CONSULTA DO ORIGINAL ÀS VARIÁVEIS DE RETORNO.
            */
            :CODIGOEMPRESAORIGINAL,
            :DATAEMISSAOORIGINAL,
            :IDPEDIDOORIGINAL,
            :CODIGOCLIENTEORIGINAL,
            :NOMECLIENTEORIGINAL,

            /*
                ATRIBUIÇÃO DOS RESULTADOS DA CONSULTA DO HISTÓRICO ÀS VARIÁVEIS DE RETORNO.
            */
            :CODIGOLOCALIZACAOCONTROL,
            :NOMELOCALIZACAOCONTROL,
            :DATALOCALIZACAOCONTROL,
            :HORALOCALIZACAOCONTROL
        DO BEGIN
            SUSPEND;
        END
END 
