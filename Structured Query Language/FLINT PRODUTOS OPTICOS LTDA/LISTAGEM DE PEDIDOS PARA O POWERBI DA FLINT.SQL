SELECT
    PEDID.EMPCODIGO,
    PEDID.PEDDTEMIS,
    PEDID.ID_PEDIDO,
    PEDID.PEDSITPED,
    TBFIS.FISCFOP,
    PEDID.PEDDTROMAN,
    PDPRD.PROCODIGO,
    PRODU.PRODESCRICAO,

    COALESCE(
        (
            SELECT FIRST 1 PDPRD2.PROCODIGO FROM PDPRD PDPRD2
            WHERE PEDID.ID_PEDIDO = PDPRD2.ID_PEDIDO
            AND PDPRD2.PROCODIGO IN ('8530','8531','8532')
        ), ''
    ) AS TRATAMENTOCODIGO,

    COALESCE(
        (
            SELECT FIRST 1 PDPRD2.PDPDESCRICAO FROM PDPRD PDPRD2
            WHERE PEDID.ID_PEDIDO = PDPRD2.ID_PEDIDO
            AND PDPRD2.PROCODIGO IN ('8530','8531','8532')
        ), ''
    ) AS TRATAMENTODESCRICAO,

    CLIEN.CLICNPJCPF,
    CLIEN.CLIRAZSOCIAL
    
FROM PEDID
    LEFT JOIN PDPRD     ON PEDID.ID_PEDIDO  = PDPRD.ID_PEDIDO
    LEFT JOIN PRODU     ON PDPRD.PROCODIGO  = PRODU.PROCODIGO
    LEFT JOIN CLIEN     ON PEDID.CLICODIGO  = CLIEN.CLICODIGO
    LEFT JOIN NVALORES  ON PDPRD.PROCODIGO  = NVALORES.PROCODIGO
    LEFT JOIN TBFIS     ON PEDID.FISCODIGO1 = TBFIS.FISCODIGO
    
WHERE
    PEDID.PEDDTEMIS BETWEEN @#DATE#DATAINICIAL@ AND @#DATE#DATAFINAL@
    AND(
        PEDID.PEDSITPED = 'F'
        OR (
            PEDID.PEDSITPED = 'A'
            AND PEDID.PEDDTSAIDA IS NOT NULL
        )
    )
    AND TBFIS.FISCFOP IN ('5.101', '5.102', '6.101', '6.102')
    AND NVALORES.GRCODIGO = 6
    
ORDER BY
    PEDID.ID_PEDIDO
;
