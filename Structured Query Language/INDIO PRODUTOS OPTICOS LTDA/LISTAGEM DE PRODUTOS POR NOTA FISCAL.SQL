EXECUTE BLOCK
RETURNS (
    SEQ CHAR(4),

    EMPCODIGO INTEGER,
    NFENRNOTA VARCHAR(13),
    NFEDTEMIS DATE,
    NFEDTENTRADA DATE,

    CLICODIGO INTEGER,
    CLIRAZSOCIAL VARCHAR(50),

    FISCODIGO CHAR(5),
    PROCODIGO VARCHAR(14),
    NFEPDESCRICAO VARCHAR(50),
    PROUN CHAR(3),
    NFEPQTDADE NUMERIC(15,6),
    NFEPPCOUNIT DOUBLE PRECISION,
    NFEPPCIPI DOUBLE PRECISION,
    NFEPPCICMS DOUBLE PRECISION,
    CLFCLASIPI VARCHAR(14),
    NFEPPCDESCTO DOUBLE PRECISION,
    VRDESCONTO DOUBLE PRECISION,
    VRIPI DOUBLE PRECISION,
    VRICMSST DOUBLE PRECISION,
    VRTOTAL DOUBLE PRECISION,
    NFEPVRSEGURO DOUBLE PRECISION,
    NFEPVRDESPESA DOUBLE PRECISION,

    DUMMY CHAR(4)
)

AS

    DECLARE VARIABLE VAR_EMPCODIGO INTEGER = NULL;

    DECLARE VARIABLE VAR_USA_NFE_NR_NOTA CHAR(1) =  '';
    DECLARE VARIABLE VAR_NFENRNOTA VARCHAR(13) = '';

    DECLARE VARIABLE VAR_USA_NFE_DT_EMISSAO CHAR(1) = '';
    DECLARE VARIABLE VAR_NFEDTEMIS_INICIAL DATE = '01.01.1999';
    DECLARE VARIABLE VAR_NFEDTEMIS_FINAL DATE = '01.01.1999';

    DECLARE VARIABLE VAR_USA_NFE_DT_ENTRADA CHAR(1) = '';
    DECLARE VARIABLE VAR_NFEDTENTRADA_INICIAL DATE = '01.01.1999';
    DECLARE VARIABLE VAR_NFEDTENTRADA_FINAL DATE = '01.01.1999';
    /*
    DECLARE VARIABLE VAR_EMPCODIGO INTEGER = 1;

    DECLARE VARIABLE VAR_USA_NFE_NR_NOTA CHAR(1) =  NULL;
    DECLARE VARIABLE VAR_NFENRNOTA VARCHAR(13) = '280688.2';

    DECLARE VARIABLE VAR_USA_NFE_DT_EMISSAO CHAR(1) = NULL;
    DECLARE VARIABLE VAR_NFEDTEMIS_INICIAL DATE = '01.01.2020';
    DECLARE VARIABLE VAR_NFEDTEMIS_FINAL DATE = '01.01.2020';

    DECLARE VARIABLE VAR_USA_NFE_DT_ENTRADA CHAR(1) = NULL;
    DECLARE VARIABLE VAR_NFEDTENTRADA_INICIAL DATE = '01.01.2020';
    DECLARE VARIABLE VAR_NFEDTENTRADA_FINAL DATE = '01.01.2020';
    */
BEGIN

FOR

SELECT

    LEFT(
        IIF(
            RDB$GET_CONTEXT('USER_TRANSACTION', 'ROW#') IS NULL,
            1, RDB$GET_CONTEXT('USER_TRANSACTION', 'ROW#')
        ), 4
    ) AS SEQ,

    NOTAE.EMPCODIGO,
    NOTAE.NFENRNOTA,
    CAST(NOTAE.NFEDTEMIS AS DATE) NFEDTEMIS,
    CAST(NOTAE.NFEDTENTRADA AS DATE) NFEDTENTRADA,

    CLIEN.CLICODIGO,
    LEFT(UPPER(CLIEN.CLIRAZSOCIAL), 50) CLIRAZSOCIAL,

    NFEPRO.FISCODIGO,
    NFEPRO.PROCODIGO,
    CAST(LEFT(NFEPRO.NFEPDESCRICAO, 50) AS VARCHAR(50)) NFEPDESCRICAO,
    PRODU.PROUN,
    NFEPRO.NFEPQTDADE,
    CAST(NFEPRO.NFEPPCOUNIT AS FLOAT) NFEPPCOUNIT,
    CAST(NFEPRO.NFEPPCIPI AS NUMERIC(15,2)) NFEPPCIPI,
    CAST(NFEPRO.NFEPPCICMS AS NUMERIC(15,2)) NFEPPCICMS,
    CLASFIS.CLFCLASIPI,
    COALESCE(NFEPRO.NFEPPCDESCTO, 0) NFEPPCDESCTO,
    (NFEPRO.NFEPVRDESCTOITEM + NFEPRO.NFEPVRDESCTOGERAL) VRDESCONTO,
    NFEPRO.NFEPVRIPI2 VRIPI,
    NFEPRO.NFEPVRICMSSUB VRICMSST,
    (
        (NFEPRO.NFEPPCOUNIT * NFEPRO.NFEPQTDADE) - (NFEPRO.NFEPVRDESCTOITEM + NFEPRO.NFEPVRDESCTOGERAL) +
        (
            NFEPRO.NFEPVRFRETE + NFEPRO.NFEPVRIPI2 + NFEPRO.NFEPVRICMSSUB +
            NFEPRO.NFEPVRSEGURO + COALESCE(NFEPRO.NFEPVRDESPESA, 0)
        )
    ) VRTOTAL,
    NFEPRO.NFEPVRSEGURO,
    COALESCE(NFEPRO.NFEPVRDESPESA, 0) NFEPVRDESPESA,

    DUMMY

FROM
    NOTAE
    LEFT JOIN CLIEN     ON NOTAE.CLICODIGO      = CLIEN.CLICODIGO
    LEFT JOIN NFEPRO    ON NOTAE.NFECODIGO      = NFEPRO.NFECODIGO
                        AND NOTAE.EMPCODIGO     = NFEPRO.EMPCODIGO
    LEFT JOIN TBFIS     ON NFEPRO.FISCODIGO     = TBFIS.FISCODIGO
    LEFT JOIN PRODU     ON NFEPRO.PROCODIGO     = PRODU.PROCODIGO
    LEFT JOIN CLASFIS   ON PRODU.PROCLASFISCAL  = CLASFIS.CLFCODIGO

    CROSS JOIN (
        SELECT RDB$SET_CONTEXT(
            'USER_TRANSACTION',
            'ROW#',
            COALESCE(CAST(RDB$GET_CONTEXT('USER_TRANSACTION', 'ROW#') AS INTEGER), 1)
        + 1) AS DUMMY
        FROM RDB$DATABASE
    ) DUMMY

WHERE

    NOTAE.EMPCODIGO = @#VARCHAR#EMPCODIGO@
    AND (
            (
                @#VARCHAR#USA_NFE_NR_NOTA@ != ''
                AND NOTAE.NFENRNOTA CONTAINING(@#VARCHAR#NFENRNOTA@)
            )
            OR(
                @#VARCHAR#USA_NFE_DT_EMISSAO@ != ''
                AND NOTAE.NFEDTEMIS BETWEEN @#DATE#NFEDTEMIS_INICIAL@ AND @#DATE#NFEDTEMIS_FINAL@
            )
            OR(
                @#VARCHAR#USA_NFE_DT_ENTRADA@ != ''
                AND NOTAE.NFEDTENTRADA BETWEEN @#DATE#NFEDTENTRADA_INICIAL@ AND @#DATE#NFEDTENTRADA_FINAL@
            )
    )

    AND (
        TBFIS.FISTPNATOP = 'RRG' OR TBFIS.FISTPNATOP = 'RRB' OR TBFIS.FISTPNATOP = 'OE' OR
        TBFIS.FISTPNATOP = 'EG' OR  TBFIS.FISTPNATOP = 'C' OR  TBFIS.FISTPNATOP = 'T' OR
        TBFIS.FISTPNATOP = 'I' OR  TBFIS.FISTPNATOP = 'A' OR  TBFIS.FISTPNATOP = 'D'
    )
    AND NOTAE.NFESIT = 'N'
    AND NOTAE.NFETIPO = 'E'

UNION ALL

SELECT

    LEFT(
        IIF(
            RDB$GET_CONTEXT('USER_TRANSACTION', 'ROW#') IS NULL,
            1, RDB$GET_CONTEXT('USER_TRANSACTION', 'ROW#')
        ), 4
    ) AS SEQ,

    NOTAE.EMPCODIGO,
    NOTAE.NFENRNOTA,
    CAST(NOTAE.NFEDTEMIS AS DATE) NFEDTEMIS,
    CAST(NOTAE.NFEDTENTRADA AS DATE) NFEDTENTRADA,

    CLIEN.CLICODIGO,
    LEFT(UPPER(CLIEN.CLIRAZSOCIAL), 50) CLIRAZSOCIAL,

    NFESER.FISCODIGO,
    CAST(NFESER.SERCODIGO AS CHAR(14)) PROCODIGO,
    CAST(LEFT(NFESER.NFESDESCRICAO, 50) AS VARCHAR(50)) NFEPDESCRICAO,
    SERVI.SERUN PROUN,
    NFESER.NFESQTDADE NFEPQTDADE,
    CAST(NFESER.NFESVALOR AS FLOAT) NFEPPCOUNIT,
    CAST(0 AS NUMERIC(15,2)) NFEPPCIPI,
    CAST(0 AS NUMERIC(15,2)) NFEPPCICMS,
    CAST(NULL AS VARCHAR(14)) CLFCLASIPI,
    COALESCE(NFESER.NFESPCDESCTO, 0) NFEPPCDESCTO,
    (NFESER.NFESVRDESCTOITEM + NFESER.NFESVRDESCTOGERAL) VRDESCONTO,
    NFESER.NFESVRIPI2 VRIPI,
    NFESER.NFESVRICMSSUB VRICMSST,
    (
        ( NFESER.NFESUNITLIQUIDO * NFESER.NFESQTDADE ) - (NFESER.NFESVRDESCTOITEM + NFESER.NFESVRDESCTOGERAL) +
        (
            NFESER.NFESVRFRETE + NFESER.NFESVRIPI2 + NFESER.NFESVRICMSSUB +
            NFESER.NFESVRSEGURO + COALESCE(NFESER.NFESVRDESPESA, 0)
        )
    ) VRTOTAL,
    NFESER.NFESVRSEGURO,
    COALESCE(NFESER.NFESVRDESPESA, 0),

    DUMMY

FROM
    NOTAE
    LEFT JOIN CLIEN     ON NOTAE.CLICODIGO      = CLIEN.CLICODIGO
    LEFT JOIN NFESER    ON NOTAE.NFECODIGO      = NFESER.NFECODIGO
                        AND NOTAE.EMPCODIGO     = NFESER.EMPCODIGO
    LEFT JOIN TBFIS     ON NFESER.FISCODIGO     = TBFIS.FISCODIGO
    LEFT JOIN SERVI     ON NFESER.SERCODIGO     = SERVI.SERCODIGO

    CROSS JOIN (
        SELECT RDB$SET_CONTEXT(
            'USER_TRANSACTION',
            'ROW#',
            COALESCE(CAST(RDB$GET_CONTEXT('USER_TRANSACTION', 'ROW#') AS INTEGER), 1)
        + 1) AS DUMMY
        FROM RDB$DATABASE
    ) DUMMY

WHERE

    NOTAE.EMPCODIGO = @#VARCHAR#EMPCODIGO@
    AND (
            (
                @#VARCHAR#USA_NFE_NR_NOTA@ != ''
                AND NOTAE.NFENRNOTA CONTAINING(@#VARCHAR#NFENRNOTA@)
            )
            OR(
                @#VARCHAR#USA_NFE_DT_EMISSAO@ != ''
                AND NOTAE.NFEDTEMIS BETWEEN @#DATE#NFEDTEMIS_INICIAL@ AND @#DATE#NFEDTEMIS_FINAL@
            )
            OR(
                @#VARCHAR#USA_NFE_DT_ENTRADA@ != ''
                AND NOTAE.NFEDTENTRADA BETWEEN @#DATE#NFEDTENTRADA_INICIAL@ AND @#DATE#NFEDTENTRADA_FINAL@
            )
    )

    AND(
        TBFIS.FISTPNATOP = 'RRG' OR TBFIS.FISTPNATOP = 'RRB' OR TBFIS.FISTPNATOP = 'OE' OR
        TBFIS.FISTPNATOP = 'EG' OR TBFIS.FISTPNATOP = 'C' OR TBFIS.FISTPNATOP = 'T' OR
        TBFIS.FISTPNATOP = 'I' OR TBFIS.FISTPNATOP = 'A' OR TBFIS.FISTPNATOP = 'D'
    )
    AND NOTAE.NFESIT = 'N'
    AND NOTAE.NFETIPO = 'E'

INTO
    :SEQ,

    :EMPCODIGO,
    :NFENRNOTA,
    :NFEDTEMIS,
    :NFEDTENTRADA,

    :CLICODIGO,
    :CLIRAZSOCIAL,

    :FISCODIGO,
    :PROCODIGO,
    :NFEPDESCRICAO,
    :PROUN,
    :NFEPQTDADE,
    :NFEPPCOUNIT,
    :NFEPPCIPI,
    :NFEPPCICMS,
    :CLFCLASIPI,
    :NFEPPCDESCTO,
    :VRDESCONTO,
    :VRIPI,
    :VRICMSST,
    :VRTOTAL,
    :NFEPVRSEGURO,
    :NFEPVRDESPESA,

    :DUMMY

DO
    BEGIN
        SUSPEND;
    END
END 
