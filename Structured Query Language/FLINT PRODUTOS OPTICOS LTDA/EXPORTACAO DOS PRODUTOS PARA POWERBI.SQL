--p/ mauro

SELECT
    PEDID.PEDCODIGO AS "COD_PEDIDO",
    PEDID.PEDDTEMIS AS "DT_EMISSAO",
    PRODU.PROCODIGO AS "COD_PRODUTO",
    CAST(PRODU.PRODESCRICAO AS VARCHAR(255)) AS "DESC_PRODUTO",
    COALESCE(
        (
            SELECT FIRST 1 PRODU.PROCODIGO FROM PDPRD PDPRD2
            LEFT JOIN PRODU PRODU2 ON PDPRD2.PROCODIGO = PRODU2.PROCODIGO
            WHERE PDPRD2.ID_PEDIDO = PEDID.ID_PEDIDO
            AND PRODU2.PROTIPO = 'T'
        ),
    '') AS "TRATAMENTO",
    PEDID.PEDSITPED AS "SITUACAO",
    CLIEN.CLICNPJCPF,
    CLIEN.CLIRAZSOCIAL,
    PDPRD.FISCODIGO,
    PEDID.EMPCODIGO

FROM PEDID
    LEFT JOIN TPPEDID       ON PEDID.TPCODIGO   = TPPEDID.TPCODIGO
    LEFT JOIN PEDIDORIGEM   ON PEDID.PEDORIGEM  = PEDIDORIGEM.PDOCODIGO
    LEFT JOIN PDPRD         ON PEDID.ID_PEDIDO  = PDPRD.ID_PEDIDO
    LEFT JOIN TBFIS         ON PDPRD.FISCODIGO  = TBFIS.FISCODIGO
    LEFT JOIN PRODU         ON PDPRD.PROCODIGO  = PRODU.PROCODIGO
    LEFT JOIN CLIEN         ON PEDID.CLICODIGO  = CLIEN.CLICODIGO
    LEFT JOIN MARCA         ON PRODU.MARCODIGO  = MARCA.MARCODIGO

WHERE
    PEDID.ID_PEDIDO IS NOT NULL
    AND PEDID.PEDDTEMIS BETWEEN '01.10.2024' AND '20.10.2024'
    --AND PEDID.PEDDTEMIS BETWEEN @#DATE#DT_INICIAL@ AND @#DATE#DT_FINAL@
    AND PEDID.PEDSITPED IN ('A', 'F')
    AND PRODU.MARCODIGO IN (
        '72', '75', '76', '176', '207', '227', '241', '239', '228', '229',
        '230', '257', '47', '197', '55', '69'
    )

ORDER BY
    PEDID.ID_PEDIDO,
    PDPRD.PROCODIGO
;

--p/ debug

SELECT
/* CABECALHO DO PEDIDO */
    PEDID.EMPCODIGO,
    PEDID.PEDDTEMIS,
    PEDID.ID_PEDIDO,
    PEDID.PEDCODIGO,
    TPPEDID.TPCODIGO,
    TPPEDID.TPDESCRICAO,
    PEDIDORIGEM.PDOCODIGO,
    UPPER(PEDIDORIGEM.PDODESCRICAO),
    PEDID.PEDORIGEM,
    TBFIS.FISCFOP,

/* DADOS DO CLIENTE */
    CLIEN.CLICODIGO,
    LEFT(CLIEN.CLIRAZSOCIAL, 50) CLIRAZSOCIAL,
    CLIEN.CLICNPJCPF,

/* DADOS DO PRODUTO */
    PRODU.PROCODIGO,
    LEFT(PRODU.PRODESCRICAO, 50) PRODESCRICAO,
    MARCA.MARCODIGO,
    MARCA.MARNOME,

 /* DADOS DO TRATAMENTO */
    COALESCE(
        (
            SELECT FIRST 1 PRODU.PROCODIGO FROM PDPRD PDPRD2
            LEFT JOIN PRODU PRODU2 ON PDPRD2.PROCODIGO = PRODU2.PROCODIGO
            WHERE PDPRD2.ID_PEDIDO = PEDID.ID_PEDIDO
            AND PRODU2.PROTIPO = 'T'
        ),
    '') AS TRATAMENTOCODIGO,

    COALESCE(
        (
            SELECT FIRST 1 LEFT(PRODU.PRODESCRICAO, 50) FROM PDPRD PDPRD2
            LEFT JOIN PRODU PRODU2 ON PDPRD2.PROCODIGO = PRODU2.PROCODIGO
            WHERE PDPRD2.ID_PEDIDO = PEDID.ID_PEDIDO
            AND PRODU2.PROTIPO = 'T'
        ),
    '') AS TRATAMENTODESCRICAO

FROM PEDID
    LEFT JOIN TPPEDID       ON PEDID.TPCODIGO   = TPPEDID.TPCODIGO
    LEFT JOIN PEDIDORIGEM   ON PEDID.PEDORIGEM  = PEDIDORIGEM.PDOCODIGO
    LEFT JOIN PDPRD         ON PEDID.ID_PEDIDO  = PDPRD.ID_PEDIDO
    LEFT JOIN TBFIS         ON PDPRD.FISCODIGO  = TBFIS.FISCODIGO
    LEFT JOIN PRODU         ON PDPRD.PROCODIGO  = PRODU.PROCODIGO
    LEFT JOIN CLIEN         ON PEDID.CLICODIGO  = CLIEN.CLICODIGO
    LEFT JOIN MARCA         ON PRODU.MARCODIGO  = MARCA.MARCODIGO

WHERE
    PEDID.ID_PEDIDO IS NOT NULL
    --AND PEDID.PEDDTEMIS BETWEEN '01.10.2024' AND '20.10.2024'
    AND PEDID.PEDDTEMIS BETWEEN @#DATE#DT_INICIAL@ AND @#DATE#DT_FINAL@
    AND PEDID.PEDSITPED IN ('A', 'F')
    AND PRODU.MARCODIGO IN (
        '72', '75', '76', '176', '207', '227', '241', '239', '228', '229',
        '230', '257', '47', '197', '55', '69'
    )

ORDER BY
    PEDID.ID_PEDIDO,
    PDPRD.PROCODIGO
;
