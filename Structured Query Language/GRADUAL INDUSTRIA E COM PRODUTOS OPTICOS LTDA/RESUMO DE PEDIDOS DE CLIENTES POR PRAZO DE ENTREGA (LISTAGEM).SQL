EXECUTE BLOCK
RETURNS (
    EMPCODIGO SMALLINT,
    PEDDTEMIS DATE,
    ID_PEDIDO INTEGER,
    CLICODIGO INTEGER,
    TPCODIGO SMALLINT,
    FISCODIGO1 CHAR(7),
    PEDORIGEM CHAR(1),
    PEDSITPED CHAR(1),
    PEDPZENTRE DATE,
    PEDDTSAIDA DATE,
    ENTREGADENTROPRAZO CHAR(1)
)
AS
    DECLARE VARIABLE DATA_EMISSAO_INICIAL DATE = @#DATE#DATA_EMISSAO_INICIAL@;
    DECLARE VARIABLE DATA_EMISSAO_FINAL DATE = @#DATE#DATA_EMISSAO_FINAL@;
    DECLARE VARIABLE DATA_ATUAL DATE = CURRENT_DATE;
BEGIN
    FOR

        SELECT
            PEDID.EMPCODIGO,
            CAST(PEDID.PEDDTEMIS AS DATE) PEDDTEMIS,
            PEDID.ID_PEDIDO,
            PEDID.CLICODIGO,
            PEDID.TPCODIGO,
            PEDID.FISCODIGO1,
            PEDID.PEDORIGEM,
            PEDID.PEDSITPED,
            CAST(PEDID.PEDPZENTRE AS DATE) PEDPZENTRE,
            CAST(PEDID.PEDDTSAIDA AS DATE) PEDDTSAIDA,

            IIF(
                PEDID.PEDPZENTRE >=
                    IIF(
                        PEDID.PEDDTSAIDA IS NOT NULL,
                        PEDID.PEDDTSAIDA, CAST(:DATA_ATUAL AS TIMESTAMP)
                    ), 1, 0
            ) ENTREGADENTROPRAZO

        FROM
            PEDID
        WHERE
            PEDID.PEDDTEMIS BETWEEN :DATA_EMISSAO_INICIAL AND :DATA_EMISSAO_FINAL
            AND PEDID.PEDSITPED != 'C'
            AND PEDID.PEDPZENTRE IS NOT NULL
            AND PEDID.PEDORIGEM IN (
                'A', 'D', 'E', 'L', 'M', 'P',
                'Q', 'R', 'T', 'W', 'X', 'Z'
            )
        ORDER BY
            PEDID.ID_PEDIDO

    INTO
        :EMPCODIGO,
        :PEDDTEMIS,
        :ID_PEDIDO,
        :CLICODIGO,
        :TPCODIGO,
        :FISCODIGO1,
        :PEDORIGEM,
        :PEDSITPED,
        :PEDPZENTRE,
        :PEDDTSAIDA,
        :ENTREGADENTROPRAZO

    DO BEGIN
        SUSPEND;
    END
END
;
